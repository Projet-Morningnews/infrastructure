- name: update apt
  apt:
    update_cache: yes
  become: yes

- name: Install dependencies
  apt:
    name:
      - qemu-kvm
      - libvirt-dev
      - bridge-utils
      - libvirt-daemon-system
      - libvirt-daemon
      - virtinst
      - libosinfo-bin
      - libguestfs-tools
      - virt-top
    state: present
    become: yes

- name: Load vhost_net module
  shell: modprobe vhost_net
  become: yes

- name: vhost_net persistant mode
  shell: echo "vhost_net" | sudo tee -a /etc/modules
  become: yes

- name: Add my user to the libvirt group
  shell: usermod -aG libvirt $(whoami)
  become: yes

- name: Add my user to the libvirt-qemu group
  shell: usermod -aG libvirt-qemu $(whoami)
  become: yes

- name: Ensure libvirtd service is enabled and started
  become: yes
  ansible.builtin.service:
    name: libvirtd
    enabled: yes
    state: started


- name: Install minishift
  become: yes
  vars:
    ver: "1.34.3"
    minishift_archive: "minishift-{{ ver }}-linux-amd64.tgz"
    minishift_url: "https://github.com/minishift/minishift/releases/download/v{{ ver }}/{{ minishift_archive }}"
    minishift_dir: "minishift-{{ ver }}-linux-amd64"

  tasks:

    - name: Download minishift archive
      ansible.builtin.get_url:
        url: "{{ minishift_url }}"
        dest: "/tmp/{{ minishift_archive }}"
        mode: '0644'

    - name: Extract minishift archive
      ansible.builtin.unarchive:
        src: "/tmp/{{ minishift_archive }}"
        dest: /tmp/
        remote_src: yes

    - name: Move minishift binary to /usr/local/bin
      ansible.builtin.copy:
        src: "/tmp/{{ minishift_dir }}/minishift"
        dest: "/usr/local/bin/minishift"
        mode: '0755'

- name: Set minishift VM driver to kvm
  ansible.builtin.command: minishift config set vm-driver kvm
  become: yes
  environment:
    PATH: /usr/local/bin:{{ ansible_env.PATH }}

- name: Start minishift
  ansible.builtin.command: minishift start
  become: yes
  environment:
    PATH: /usr/local/bin:{{ ansible_env.PATH }}